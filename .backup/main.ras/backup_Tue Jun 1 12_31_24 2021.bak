program PET40;
@use "text/txt"
@use "output/screen"
@use "os/interrupts"
@use "input/key"

// Set the model of PET required
@projectsettings "petmodel" "4032"

var
	@define useKernal 0
	i,s,c,a,key_press,ALIVE,WON_GAME: byte;
	x,y,old_x,old_y: byte;
	sx,sy: integer;
	player_score: integer;
	player_lives: byte;
	des,src,src2,src3,map_p: pointer;
	n_key_up,n_key_down,n_key_left,n_key_right,key_up,key_down,key_left,key_right:integer;
	irq_ad : integer at $90;
	org_ad : integer;
	new_ad: pointer;
	sdes: pointer;
	ship: cstring=(
					$7C,$FB,$EC,$62,$7B,
					$20,$FB,$EC,$FC,$FF,
					$7C,$E2,$E2,$20,$20);


map: array[9600] of byte = (
);




	procedure init_screen();
	begin
		map_p:=#map;
		a:=0;

	end;
	
	procedure draw_screen();
	begin

		map_p:=#map+sx;	
		for i:=0 to 24 do begin
			des:=txt::ytab[i];	
			MemCpyFast(map_p, 0, des, 40 );
			map_p:=map_p+400; 
		end;
		
		txt::put_dec_at(30,24,y);
		txt::put_dec_at(0,24,sx);
		
	end;
	
	
	procedure draw_ship();
	var
		
	begin
		
		sdes := txt::ytab[y]+x;
		MemCpy(#ship, 0, sdes, 5 ); 
		sdes := sdes+40;
		MemCpy(#ship, 5, sdes, 5 );
		sdes := sdes+40;
 		MemCpy(#ship, 10, sdes, 5 ); 
		

	end;
	
	procedure draw_frame();
	begin	

	
		

		if (getbit(^$e840,5)) then			  
		begin

			incrange(a,0,360);
			if (a=1) then
			begin 
				sx:=sx+1;
				if sx=400 then sx:=0;
				draw_screen();
			end;	
			draw_ship();			
		end;
		
		//asm("	jmp (org_ad)");	
	end;
	
	procedure setup_irq();
	var
					
	begin
		
		org_ad:=(hi(irq_ad)*256)+lo(irq_ad);
		//org_ad:=irq_ad;	
		new_ad:=#draw_frame();
					
		asm("	sei	");
		irq_ad:=new_ad;
		asm("	cli	");
			
		
	end;

/* main program */  
begin




	txt::cls();
	txt::print_string("PET TEST", True);


	init_screen();
	sx:=0;
	sy:=4;
	x:=0;
	y:=10;
	
	
	//setup_irq();
	ALIVE:=1;
	WON_GAME:=0;

	
	// Numeric Keypad
	n_key_up:=Key::K8;
	n_key_down:=Key::K5;
	n_key_left:=Key::K4;
	n_key_right:=Key::K6;
	
	// Regular keys        
	key_up:=Key::KW;
	key_down:=Key::KS;
	key_left:=Key::KA;
	key_right:=Key::KD;


	while (ALIVE=1 and WON_GAME=0) do
	begin

		

		Key::Read();



        old_x:=x;
        old_y:=y;
        if(Key::Pressed(key_up) or Key::Pressed(n_key_up)) then
        begin
            if(y>1) then
            begin
                dec(y);
                if y< 5 then sy:=sy-1;
            end;
        end;
        
        if(Key::Pressed(key_right) or Key::Pressed(n_key_right)) then
        begin
            if(x<39) then
            begin
                inc(x);
            end;
        end;
        
        if(Key::Pressed(key_down) or Key::Pressed(n_key_down)) then
        begin
            if(y<24) then
            begin
                inc(y);
                if y> 15 then sy:=sy+1;
            end;
        end;
        if(Key::Pressed(key_left) or Key::Pressed(n_key_left)) then
        begin
            if(x>0) then
            begin
                dec(x);
            end;
        end;
        
  


        
        draw_frame();
		
	end;

end.



